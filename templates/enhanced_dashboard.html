<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RatCrawler Multi-Database Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .status-healthy {
        @apply bg-green-100 text-green-800 border-green-300;
      }
      .status-warning {
        @apply bg-yellow-100 text-yellow-800 border-yellow-300;
      }
      .status-critical {
        @apply bg-red-100 text-red-800 border-red-300;
      }
      .progress-healthy {
        @apply bg-green-500;
      }
      .progress-warning {
        @apply bg-yellow-500;
      }
      .progress-critical {
        @apply bg-red-500;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans" x-data="dashboardData()">
    <!-- Header -->
    <header class="bg-white shadow-md">
      <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">
              üï∑Ô∏è RatCrawler Multi-Database Monitor
            </h1>
            <p class="text-gray-600 text-sm">
              Real-time monitoring with intelligent database rotation
            </p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center">
              <div
                class="w-3 h-3 rounded-full mr-2"
                :class="connectionStatus ? 'bg-green-500' : 'bg-red-500'"
              ></div>
              <span
                class="text-sm"
                x-text="connectionStatus ? 'Connected' : 'Disconnected'"
              ></span>
            </div>
            <button
              @click="refreshData()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
            >
              <i class="fas fa-refresh mr-2"></i>Refresh
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- System Health Overview -->
    <div class="container mx-auto px-4 py-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center">
            <i class="fas fa-database text-2xl text-blue-600 mr-3"></i>
            <div>
              <h3 class="text-lg font-semibold">Total Databases</h3>
              <p
                class="text-2xl font-bold text-blue-600"
                x-text="dashboardData.summary?.total || 0"
              ></p>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-2xl text-green-600 mr-3"></i>
            <div>
              <h3 class="text-lg font-semibold">Healthy</h3>
              <p
                class="text-2xl font-bold text-green-600"
                x-text="dashboardData.summary?.healthy || 0"
              ></p>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center">
            <i
              class="fas fa-exclamation-triangle text-2xl text-yellow-600 mr-3"
            ></i>
            <div>
              <h3 class="text-lg font-semibold">Warning</h3>
              <p
                class="text-2xl font-bold text-yellow-600"
                x-text="dashboardData.summary?.warning || 0"
              ></p>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center">
            <i class="fas fa-times-circle text-2xl text-red-600 mr-3"></i>
            <div>
              <h3 class="text-lg font-semibold">Critical</h3>
              <p
                class="text-2xl font-bold text-red-600"
                x-text="dashboardData.summary?.critical || 0"
              ></p>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow">
          <div class="flex items-center">
            <i class="fas fa-cogs text-2xl text-purple-600 mr-3"></i>
            <div>
              <h3 class="text-lg font-semibold">Active Crawlers</h3>
              <p
                class="text-2xl font-bold text-purple-600"
                x-text="dashboardData.active_crawlers || 0"
              ></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Alerts Section -->
      <div x-show="dashboardData.alerts?.length > 0" class="mb-6">
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-bell text-orange-500 mr-2"></i>
            Active Alerts
          </h2>
          <template x-for="alert in dashboardData.alerts" :key="alert.id">
            <div
              class="border-l-4 p-4 mb-3 rounded"
              :class="alert.type === 'critical' ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50'"
            >
              <div class="flex justify-between items-start">
                <div>
                  <h4 class="font-semibold" x-text="alert.message"></h4>
                  <p class="text-sm text-gray-600" x-text="alert.details"></p>
                  <p
                    class="text-xs text-gray-500"
                    x-text="formatTimestamp(alert.timestamp)"
                  ></p>
                </div>
                <span
                  class="px-2 py-1 text-xs rounded font-bold"
                  :class="alert.type === 'critical' ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'"
                  x-text="alert.type.toUpperCase()"
                ></span>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Database Status Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <template
          x-for="database in dashboardData.databases"
          :key="database.name"
        >
          <div
            class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow"
          >
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-bold" x-text="database.name"></h3>
                <p class="text-sm text-gray-600">
                  <span x-text="database.type"></span> ‚Ä¢
                  <span x-text="database.organization"></span>
                </p>
              </div>
              <span
                class="px-3 py-1 text-sm rounded-full border"
                :class="'status-' + database.status"
                x-text="database.status.toUpperCase()"
              ></span>
            </div>

            <!-- Storage Usage -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-1">
                <span>Storage Usage</span>
                <span
                  x-text="formatBytes(database.storage_used) + ' / ' + formatBytes(database.storage_limit * 1073741824)"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div
                  class="h-3 rounded-full transition-all duration-500"
                  :class="database.storage_percent >= 90 ? 'progress-critical' : database.storage_percent >= 75 ? 'progress-warning' : 'progress-healthy'"
                  :style="'width: ' + Math.min(database.storage_percent, 100) + '%'"
                ></div>
              </div>
              <p
                class="text-xs text-gray-500 mt-1"
                x-text="database.storage_percent.toFixed(1) + '%'"
              ></p>
            </div>

            <!-- Write Usage -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-1">
                <span>Monthly Writes</span>
                <span
                  x-text="formatNumber(database.writes_used) + ' / ' + formatNumber(database.monthly_limit)"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div
                  class="h-3 rounded-full transition-all duration-500"
                  :class="database.writes_percent >= 90 ? 'progress-critical' : database.writes_percent >= 75 ? 'progress-warning' : 'progress-healthy'"
                  :style="'width: ' + Math.min(database.writes_percent, 100) + '%'"
                ></div>
              </div>
              <p
                class="text-xs text-gray-500 mt-1"
                x-text="database.writes_percent.toFixed(1) + '%'"
              ></p>
            </div>

            <!-- Actions -->
            <div class="flex space-x-2">
              <button
                @click="viewDatabaseDetails(database.name)"
                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded"
              >
                <i class="fas fa-eye mr-1"></i>Details
              </button>
              <button
                @click="downloadDatabaseReport(database.name)"
                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 px-3 rounded"
              >
                <i class="fas fa-download mr-1"></i>Report
              </button>
            </div>
          </div>
        </template>
      </div>

      <!-- Analytics and Controls -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Crawling Control Panel -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-spider text-blue-600 mr-2"></i>
            Crawling Control Panel
          </h2>

          <form @submit.prevent="startCrawl()">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2"
                >URLs to Crawl</label
              >
              <textarea
                x-model="crawlForm.urls"
                placeholder="Enter URLs, one per line"
                class="w-full border rounded-lg p-3 h-24 text-sm"
                required
              ></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium mb-2">Max Depth</label>
                <input
                  type="number"
                  x-model="crawlForm.max_depth"
                  min="1"
                  max="5"
                  class="w-full border rounded-lg p-2 text-sm"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Delay (seconds)</label
                >
                <input
                  type="number"
                  x-model="crawlForm.delay"
                  min="0.5"
                  max="10"
                  step="0.5"
                  class="w-full border rounded-lg p-2 text-sm"
                />
              </div>
            </div>

            <button
              type="submit"
              :disabled="crawling"
              class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-3 rounded-lg"
            >
              <i class="fas fa-play mr-2"></i>
              <span x-text="crawling ? 'Crawling...' : 'Start Crawling'"></span>
            </button>
          </form>

          <!-- Active Crawl Sessions -->
          <div x-show="activeCrawls.length > 0" class="mt-6">
            <h3 class="font-semibold mb-3">Active Crawl Sessions</h3>
            <template x-for="crawl in activeCrawls" :key="crawl.session_id">
              <div class="bg-gray-50 p-3 rounded-lg mb-2">
                <div class="flex justify-between items-center">
                  <div>
                    <span
                      class="font-mono text-sm"
                      x-text="crawl.session_id"
                    ></span>
                    <span
                      class="ml-2 px-2 py-1 text-xs rounded"
                      :class="crawl.status === 'running' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'"
                      x-text="crawl.status"
                    ></span>
                  </div>
                  <button
                    @click="viewCrawlLogs(crawl.session_id)"
                    class="text-blue-600 hover:text-blue-800"
                  >
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- System Analytics -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-chart-bar text-green-600 mr-2"></i>
            System Analytics
          </h2>

          <!-- Performance Metrics -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-blue-50 p-3 rounded-lg">
              <h4 class="font-semibold text-blue-800">Pages Crawled</h4>
              <p
                class="text-2xl font-bold text-blue-600"
                x-text="analytics.total_pages_crawled || 0"
              ></p>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
              <h4 class="font-semibold text-green-800">Backlinks Found</h4>
              <p
                class="text-2xl font-bold text-green-600"
                x-text="analytics.total_backlinks_found || 0"
              ></p>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg">
              <h4 class="font-semibold text-purple-800">Domains</h4>
              <p
                class="text-2xl font-bold text-purple-600"
                x-text="analytics.unique_domains_discovered || 0"
              ></p>
            </div>
            <div class="bg-orange-50 p-3 rounded-lg">
              <h4 class="font-semibold text-orange-800">Sessions</h4>
              <p
                class="text-2xl font-bold text-orange-600"
                x-text="analytics.crawling_sessions_completed || 0"
              ></p>
            </div>
          </div>

          <!-- Recent Activities -->
          <div>
            <h3 class="font-semibold mb-3">Recent Activities</h3>
            <div class="space-y-2 max-h-48 overflow-y-auto">
              <template
                x-for="activity in dashboardData.recent_activities"
                :key="activity.timestamp"
              >
                <div class="bg-gray-50 p-2 rounded text-sm">
                  <div class="flex justify-between">
                    <span x-text="activity.type.replace('_', ' ')"></span>
                    <span
                      class="text-gray-500"
                      x-text="formatTimestamp(activity.timestamp)"
                    ></span>
                  </div>
                  <p
                    class="text-gray-600"
                    x-text="getActivityDescription(activity)"
                  ></p>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Database Details Modal -->
    <div
      x-show="showDatabaseModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h2
            class="text-xl font-bold"
            x-text="'Database Details: ' + selectedDatabase"
          ></h2>
          <button
            @click="showDatabaseModal = false"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div x-html="databaseDetails"></div>
      </div>
    </div>

    <!-- Crawl Logs Modal -->
    <div
      x-show="showLogsModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Crawl Logs</h2>
          <button
            @click="showLogsModal = false"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div
          class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto"
        >
          <template x-for="log in crawlLogs" :key="log.timestamp">
            <div>
              <span x-text="log.timestamp"></span>
              <span x-text="'[' + log.level.toUpperCase() + ']'"></span>
              <span x-text="log.message"></span>
            </div>
          </template>
        </div>
      </div>
    </div>

    <script>
      function dashboardData() {
        return {
          dashboardData: {{ data | tojson }},
          analytics: {{ data.get('analytics', {}) | tojson }},
          connectionStatus: true,
          crawling: false,
          activeCrawls: [],
          showDatabaseModal: false,
          showLogsModal: false,
          selectedDatabase: '',
          databaseDetails: '',
          crawlLogs: [],
          crawlForm: {
            urls: '',
            max_depth: 3,
            delay: 1.5
          },
          websocket: null,

          init() {
            this.connectWebSocket();
            this.loadAnalytics();
          },

          connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            this.websocket = new WebSocket(`${protocol}//${window.location.host}/ws`);

            this.websocket.onopen = () => {
              this.connectionStatus = true;
            };

            this.websocket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              if (data.type === 'dashboard_update') {
                this.dashboardData = data.data;
              } else if (data.type === 'alert') {
                this.showAlert(data.alert);
              }
            };

            this.websocket.onclose = () => {
              this.connectionStatus = false;
              // Attempt to reconnect after 5 seconds
              setTimeout(() => this.connectWebSocket(), 5000);
            };
          },

          async refreshData() {
            try {
              const response = await fetch('/api/status');
              this.dashboardData = await response.json();
            } catch (error) {
              console.error('Error refreshing data:', error);
            }
          },

          async loadAnalytics() {
            try {
              const response = await fetch('/api/analytics/summary');
              this.analytics = await response.json();
            } catch (error) {
              console.error('Error loading analytics:', error);
            }
          },

          async startCrawl() {
            this.crawling = true;
            try {
              const urls = this.crawlForm.urls.split('\\n').filter(url => url.trim());
              const response = await fetch('/api/crawl/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  urls: urls,
                  config: {
                    max_depth: parseInt(this.crawlForm.max_depth),
                    delay: parseFloat(this.crawlForm.delay)
                  }
                })
              });

              if (response.ok) {
                const result = await response.json();
                this.activeCrawls.push({
                  session_id: result.session_id,
                  status: result.status
                });
                this.crawlForm.urls = '';
              }
            } catch (error) {
              console.error('Error starting crawl:', error);
              alert('Error starting crawl: ' + error.message);
            } finally {
              this.crawling = false;
            }
          },

          async viewDatabaseDetails(dbName) {
            this.selectedDatabase = dbName;
            try {
              const response = await fetch(`/api/database/${dbName}`);
              const details = await response.json();
              this.databaseDetails = this.formatDatabaseDetails(details);
              this.showDatabaseModal = true;
            } catch (error) {
              console.error('Error loading database details:', error);
            }
          },

          async viewCrawlLogs(sessionId) {
            try {
              const response = await fetch(`/api/crawl/logs/${sessionId}`);
              const logs = await response.json();
              this.crawlLogs = logs.logs || [];
              this.showLogsModal = true;
            } catch (error) {
              console.error('Error loading crawl logs:', error);
            }
          },

          formatDatabaseDetails(details) {
            return `
              <div class="space-y-4">
                <div><strong>Status:</strong> ${details.health.status}</div>
                <div><strong>Storage:</strong> ${this.formatBytes(details.health.storage_used)} / ${this.formatBytes(details.storage_limit * 1073741824)}</div>
                <div><strong>Writes:</strong> ${this.formatNumber(details.health.writes_used)} / ${this.formatNumber(details.monthly_limit)}</div>
                <div><strong>Recent Activity:</strong></div>
                <ul class="list-disc list-inside ml-4">
                  ${details.recent_activity.map(activity => `<li>${activity.action}: ${activity.records} records (${this.formatTimestamp(activity.timestamp)})</li>`).join('')}
                </ul>
              </div>
            `;
          },

          formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          },

          formatNumber(num) {
            return new Intl.NumberFormat().format(num);
          },

          formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
          },

          getActivityDescription(activity) {
            switch(activity.type) {
              case 'crawl_started':
                return `Started crawling ${activity.urls_count} URLs`;
              default:
                return '';
            }
          },

          showAlert(alert) {
            // Add alert to the list if not already present
            if (!this.dashboardData.alerts.find(a => a.id === alert.id)) {
              this.dashboardData.alerts.unshift(alert);
            }
          },

          downloadDatabaseReport(dbName) {
            // Implement database report download
            window.open(`/api/database/${dbName}/report`, '_blank');
          }
        }
      }
    </script>
  </body>
</html>
